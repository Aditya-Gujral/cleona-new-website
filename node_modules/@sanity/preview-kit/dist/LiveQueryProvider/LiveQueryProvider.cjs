"use strict";var e=require("react/jsx-runtime"),t=require("@sanity/client/csm"),r=require("@sanity/preview-kit-compat"),s=require("@vercel/stega"),n=require("lru-cache"),o=require("mendoza"),c=require("react"),a=require("../context.cjs");const i=new n.LRUCache({max:500}),u=c.memo((function(t){const{children:r,refreshInterval:s=1e4,token:n}=t;if(!t.client)throw new Error("Missing a `client` prop with a configured Sanity client instance");const[o]=c.useState((()=>{const{requestTagPrefix:e,resultSourceMap:r}=t.client.config();return t.client.withConfig({requestTagPrefix:e||"sanity.preview-kit",resultSourceMap:"withKeyArraySelector"!==r||"withKeyArraySelector",...n&&{token:n,useCdn:!1,perspective:"previewDrafts",ignoreBrowserTokenWarning:!0}})})),[i]=c.useState((()=>t.logger));c.useEffect((()=>{i&&i.log("[@sanity/preview-kit]: With the current configuration you can expect that: Updates that can be traced using Content Source Maps will be applied in real-time. Other updates will be applied every ".concat(s,"ms."))}),[i,s]);const[u,d]=c.useState([]),[p]=c.useState((()=>new Map)),h=function(e){const[t]=c.useState((()=>new Map)),r=c.useCallback(((r,s,n,o)=>{t.has(r)||(t.set(r,{query:s,params:n,listeners:new Set}),c.startTransition((()=>e((e=>e.includes(r)?e:[...e,r])))));const a=t.get(r);if(!a||!a.listeners)throw new TypeError("Inconsistent cache for key: "+r);const{listeners:i}=a;return i.add(o),()=>{i.delete(o),0===i.size&&(t.delete(r),c.startTransition((()=>e((e=>e.includes(r)?e.filter((e=>e!==r)):e)))))}}),[t,e]);return c.useMemo((()=>({cache:t,subscribe:r})),[t,r])}(d),[m]=c.useState((()=>function(e,t,r){const s=g(t,r);p.has(s)||p.set(s,{result:e,resultSourceMap:{}});return{subscribe:e=>{const n=h.subscribe(s,t,r,e);return()=>n()},getSnapshot:()=>{var e;return null==(e=p.get(s))?void 0:e.result}}})),[S,v]=c.useState([]),[y]=c.useState((()=>new Map)),w=c.useCallback((e=>{var t;const r=new Set;if(y.clear(),null==(t=e.documents)?void 0:t.length)for(const t of e.documents)r.add(t._id),y.set(t._id,t);c.startTransition((()=>v((e=>{const t=Array.from(new Set([...e,...r]));return JSON.stringify(t.sort())===JSON.stringify(e.sort())?e:t}))))}),[y]);return e.jsxs(a.defineStoreContext.Provider,{value:m,children:[r,e.jsx(f,{cache:h.cache,client:o,setTurboIds:v,snapshots:p,turboIds:S,docsInUse:y}),u.map((t=>{if(!h.cache.has(t))return null;const{query:r,params:n,listeners:c}=h.cache.get(t);return e.jsx(l,{client:o,listeners:c,params:n,query:r,refreshInterval:s,snapshots:p,turboIdsFromSourceMap:w},t)}))]})}));u.displayName="LiveStoreProvider";const l=c.memo((function(e){const{client:t,refreshInterval:s,query:n,params:o,listeners:a,snapshots:i,turboIdsFromSourceMap:u}=e,{projectId:l,dataset:d}=c.useMemo((()=>{const{projectId:e,dataset:r}=t.config();return{projectId:e,dataset:r}}),[t]),[f,p]=c.useState(null);if(f)throw f;const[h,S]=r.useRevalidate({refreshInterval:s}),v="refresh"===h||"inflight"===h;return c.useEffect((()=>{if(!v)return;let e=!1;const r=new AbortController;const s=S();return async function(){const{signal:s}=r,{result:c,resultSourceMap:f}=await t.fetch(n,o,{signal:s,filterResponse:!1});if(!s.aborted){i.set(g(n,o),{result:m(l,d,c,f),resultSourceMap:null!=f?f:{}}),f&&u(f);for(const e of a.values())e();e=!0}}().catch((e=>{"AbortError"!==e.name&&p(e)})).finally(s),()=>{e||r.abort()}}),[t,d,a,o,l,n,v,i,S,u]),null}));function d(e,t,r){return"".concat(e,"-").concat(t,"-").concat(r)}l.displayName="QuerySubscription";const f=c.memo((function(t){const{client:s,snapshots:n,cache:a,turboIds:u,setTurboIds:l,docsInUse:f}=t,{projectId:h,dataset:S}=c.useMemo((()=>{const{projectId:e,dataset:t}=s.config();return{projectId:e,dataset:t}}),[s]);c.useEffect((()=>{var e,t;const r=new Set;f.clear();for(const{query:s,params:o}of a.values()){const c=g(s,o),a=n.get(c);if(a&&(null==(t=null==(e=a.resultSourceMap)?void 0:e.documents)?void 0:t.length))for(const e of a.resultSourceMap.documents)r.add(e._id),f.set(e._id,e)}const s=[...r].sort();JSON.stringify(u)!==JSON.stringify(s)&&c.startTransition((()=>l(s)))}),[a,l,n,u,f]),r.useDocumentsInUse(f,h,S);const[v,y]=c.useState([]);c.useEffect((()=>{const e=new Set(v.flat()),t=new Set;for(const r of u)e.has(r)||i.has(d(h,S,r))||t.add(r);const r=[...t].slice(0,100);0!==r.length&&c.startTransition((()=>y((e=>[...e.slice(-100),r]))))}),[v,S,h,u]);const[w,b]=c.useState();return c.useEffect((()=>{const e=s.listen("*",{},{events:["mutation"],effectFormat:"mendoza",includePreviousRevision:!1,includeResult:!1,tag:"turbo"}).subscribe((e=>{var t,r;if("mutation"!==e.type||!(null==(r=null==(t=e.effects)?void 0:t.apply)?void 0:r.length))return;const s=d(h,S,e.documentId),n=i.peek(s);if(n){const t={...n};delete t._rev;const r=o.applyPatch(t,e.effects.apply);i.set(s,r)}c.startTransition((()=>b(e.documentId)))}));return()=>e.unsubscribe()}),[s,S,h]),c.useEffect((()=>{var e,t,r;if(!w||!u.includes(w))return;const s=[];for(const[r,o]of n.entries())(null==(t=null==(e=o.resultSourceMap)?void 0:e.documents)?void 0:t.length)&&(o.result=m(h,S,o.result,o.resultSourceMap),s.push(r));for(const e of s){const t=null==(r=a.get(e))?void 0:r.listeners;if(t)for(const e of t)e()}c.startTransition((()=>b(void 0)))}),[a,S,w,h,n,u]),e.jsx(e.Fragment,{children:v.map((t=>e.jsx(p,{client:s,projectId:h,dataset:S,ids:t},JSON.stringify(t))))})}));f.displayName="Turbo";const p=c.memo((function(e){const{client:t,projectId:r,dataset:s,ids:n}=e;return c.useEffect((()=>{const e=n.filter((e=>!i.has(d(r,s,e))));0!==e.length&&t.getDocuments(e).then((e=>{for(const t of e)t&&(null==t?void 0:t._id)&&i.set(d(r,s,t._id),t)}),console.error)}),[t,s,n,r]),null}));p.displayName="GetDocuments";let h=!1;function m(e,r,n,o){return o?t.applySourceDocuments(n,o,(t=>{if(!t._projectId)return i.get(d(e,r,t._id));h||(console.warn("Cross dataset references are not supported yet, ignoring source document",t),h=!0)}),((e,{previousValue:t})=>{if("string"==typeof e&&"string"==typeof t){const{encoded:r}=s.vercelStegaSplit(t),{cleaned:n}=s.vercelStegaSplit(e);return"".concat(r).concat(n)}return e}),"previewDrafts"):n}function g(e,t){return"".concat(e,"-").concat(JSON.stringify(t))}module.exports=u;
//# sourceMappingURL=LiveQueryProvider.cjs.map
